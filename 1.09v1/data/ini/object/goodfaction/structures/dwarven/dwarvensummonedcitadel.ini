//------------------------------------------------------------------------------
// These are the build plots for the Citadel
Object DwarvenSummonedCitadelExpansionPad
	
	SelectPortrait = BPDFortress_BuildPlot
	
	;// *** ART Parameters ***

	Draw = W3DFloorDraw DrawFloorBase  
		ModelName = DBFoundation
	End
	
	Draw = W3DScriptedModelDraw ModuleTag_DrawMain
		DefaultModelConditionState
			Model = WBFoundationP
		End
		;//Remove the buildplot when it's been constructed on
		ModelConditionState = CONSTRUCTION_COMPLETE
			Model = None
		End		
	End

	;//PlacementViewAngle  = 0

	;// ***DESIGN parameters ***
	DisplayName         = OBJECT:DwarvenBuildingFoundation
	Side                = Dwarves
	EditorSorting       = STRUCTURE
	ThreatLevel = 1.0

	BuildCost           = 1
	BuildTime           = 5.0          ;// in seconds
	VisionRange         = 0.0          ;// Shroud clearing distance
	ShroudClearingRange = 0

	CommandSet = DwarvenSummonedCitadelPadCommandSet

	;// *** AUDIO Parameters ***

	VoiceSelect = Gui_PlotSelect2	;MenFortressSelect

	;// *** ENGINEERING Parameters ***	
	KindOf              = STRUCTURE SELECTABLE IMMOBILE BASE_FOUNDATION UNATTACKABLE MP_COUNT_FOR_VICTORY NO_COLLIDE DO_NOT_CLASSIFY

	Behavior            = FoundationAIUpdate ModuleTag_foundationAI
		BuildVariation = 1 ;// Will give BUILD_VARIATION_TWO to anything built on it
	End

	Behavior = CastleMemberBehavior ModuleTag_CMB
	End 

	Body                = ImmortalBody ModuleTag_05
		MaxHealth         = 13000 ; ; 15000.0
	End

	Geometry              = BOX
	GeometryMajorRadius   = 5.0
	GeometryMinorRadius   = 5.0
	GeometryHeight        = 0.8
	GeometryIsSmall       = No
	Shadow                = NONE
	BuildCompletion			= PLACED_BY_PLAYER
End


//------------------------------------------------------------------------------
// This is the Dwarven Summoned Citadel
Object DwarvenSummonedCitadelKeep
	 
	// *** ART Parameters ***
		SelectPortrait         = BPDCitadel
	//	ButtonImage            = SNReactor

	//--------------------------------
	Draw = W3DScriptedModelDraw ModuleTag_MainDraw
		OkToChangeModelColor	= Yes
		UseStandardModelNames	= Yes

		ExtraPublicBone			= ARROW01
		ExtraPublicBone			= ARROW02
		ExtraPublicBone			= ARROW03
		ExtraPublicBone			= ARROW04
		ExtraPublicBone			= ARROW05
		ExtraPublicBone			= ARROW06
		ExtraPublicBone			= ARROW07
		
		DefaultModelConditionState
			Model = DBCitadel
			WeaponLaunchBone	= PRIMARY ARROW
			WeaponLaunchBone	= SECONDARY		ARROW ; ;bt
			WeaponLaunchBone	= TERTIARY		ARROW
			WeaponLaunchBone	= QUATERNARY	ARROW
			WeaponLaunchBone	= QUINARY		ARROW
		End

		IdleAnimationState						
		End

		//------------Build Up States   
		ModelConditionState		= SNOW BASE_BUILD
			Model               = DBCitadel_A	
			Texture = DBCitStatue.tga DBCitStatue_snow.tga
			Texture = DBStoneA.tga DBStoneA_Snow.tga
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End
		ModelConditionState		= BASE_BUILD
			Model               = DBCitadel_A	
			ParticleSysBone     = NONE BuildingContructDust
		End  

		AnimationState		  = BASE_BUILD
			Animation
				AnimationName = DBCitadel_A.DBCitadel_A
				AnimationMode = ONCE
				AnimationBlendTime = 0			
				AnimationSpeedFactorRange = 10.0 10.0 ; 300 frame anim, but need to shrink down to 5 seconds
			End
			BeginScript
				//CurDrawablePlaySound("GondorBarracksBeginConstruction")
				CurDrawablePlaySound("BuildingTopple")
			EndScript
		End

		ModelConditionState		= SNOW JUST_BUILT
			Model               = DBCitadel_A	
			Texture = DBCitStatue.tga DBCitStatue_snow.tga
			Texture = DBStoneA.tga DBStoneA_Snow.tga
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End

		ModelConditionState   = JUST_BUILT
			Model               = DBCitadel_A
		End
	    
		AnimationState		  = JUST_BUILT
			Animation
				AnimationName = DBCitadel_A.DBCitadel_A
				AnimationMode = MANUAL			
				AnimationBlendTime = 0
			End
			Flags = START_FRAME_FIRST
		End
		
		//------------- Damge -------------------
		ModelConditionState = DAMAGED
			Model					= DBCitadel_D1
		End  
		AnimationState = DAMAGED
			EnteringStateFX = FX_FortressDamaged
		End

		ModelConditionState = REALLYDAMAGED
			Model					= DBCitadel_D2
		End  
		AnimationState = REALLYDAMAGED
			Animation	= RubbleAnimation
				AnimationName		=	DBCitadel_D2.DBCitadel_D2
				AnimationMode		=	ONCE	
	  		End
			EnteringStateFX = FX_FortressReallyDamaged
		End

		ModelConditionState = RUBBLE
			Model					= DBCitadel_D3
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End
		AnimationState = RUBBLE
			Animation	= RubbleAnimation
				AnimationName		=	DBCitadel_D3.DBCitadel_D3
				AnimationMode		=	ONCE	
	  		End
		End
		
		ModelConditionState	=	SNOW
			Model = DBCitadel
			Texture = DBCitStatue.tga DBCitStatue_snow.tga
			Texture = DBStoneA.tga DBStoneA_Snow.tga
			Texture = DBFortress1.tga DBFortress1_Snow.tga
		End
	End

  
	Draw = W3DFloorDraw ModuleTag_DrawFloor    
		StaticModelLODMode = Yes		; THIS NEEDS TO BE COMMENTED OUT WHEN ENGINEERING ENABLES LOD'S IN THE FLOOR DRAW
		ModelName = DBCitadel_Bib
		WeatherTexture		= SNOWY DBCitStatue_Bib_S.tga
  		HideIfModelConditions	=	AWAITING_CONSTRUCTION
  		HideIfModelConditions	=	PARTIALLY_CONSTRUCTED
	End

	// ***DESIGN parameters ***
	DisplayName         	= OBJECT:DwarvenSummonedCitadel
	Side                	= Dwarves
	EditorSorting       	= STRUCTURE
	ThreatLevel				= 1.0
	CommandPointBonus		= GENERIC_ECONOMY_COMMAND_POINT_BONUS

	BuildCost				= 0
	BuildTime				= 5.0           ; in seconds
	VisionRange				= 350.0 ; ;160.0          
	ShroudClearingRange		= 550.0 ; ;200

	CommandSet				= SellableCommandSet
	
	ArmorSet
		Conditions			= None
		Armor				= FortressArmor	
	End

	WeaponSet
		Weapon				= PRIMARY FortressStructureAxeWeapon
		AutoChooseSources	= PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End 
	
	// *** AUDIO Parameters ***

	VoiceSelect						= DwarfCitadelSelect
	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction

	SoundOnDamaged					= BuildingLightDamageStone
	SoundOnReallyDamaged			= BuildingHeavyDamageStone

	UnitSpecificSounds
		UnderConstruction			= BuildingConstructionLoop  ;// Built first time
		UnderRepairFromRubble		= BuildingConstructionLoop	;// Repaired from completely destroyed (not used???)
	End

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

    CampnessValue = CAMPNESS_SUMMONED_CITADEL

	// *** ENGINEERING Parameters ***
	RadarPriority       = STRUCTURE 	
	KindOf				= PRELOAD COMMANDCENTER VITAL_FOR_BASE_SURVIVAL STRUCTURE IMMOBILE CASTLE_KEEP MP_COUNT_FOR_VICTORY SELECTABLE FS_FACTORY AUTO_RALLYPOINT SCORE DOZER_FACTORY DONT_USE_CANCEL_BUILD_BUTTON SUMMONED	GARRISON GARRISONABLE_UNTIL_DESTROYED

	Behavior            = GettingBuiltBehavior ModuleTag_GettingBuiltBehavior
		//WorkerName	= DwarvenWorkerNoSelect
		UseSpawnTimerWithoutWorker 	= Yes
		SpawnTimer					= DEFAULT_STRUCTURE_HEALDELAY		
	End

     Behavior = CastleMemberBehavior ModuleTag_CMB
		BeingBuiltSound = BuildingBigConstructionLoop
     End 

	Behavior = TerrainResourceBehavior ModuleTag_NewMoneyDeadSpot
		Radius			= 150		// How far we try to claim ground
		MaxIncome		= 0			// If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= 999999	// How often (in msec) we give that much money
		HighPriority	= Yes		// A high priority claim gets to pretend it was there first.
	End

	//-----------------------------------------------	
	Behavior = ProductionUpdate ProductionUpdateModuleTag
  		NumDoorAnimations            = 1
		DoorOpeningTime              = 3000  //in mSeconds how long you want doors to be in open state


		DoorWaitOpenTime             = 3000  //in mSeconds time the door stays open, so units can exit
		DoorCloseTime                = 3000  //in mSeconds how long you want doors to be in open state		
	End

	Behavior = QueueProductionExitUpdate ModuleTag_QueuePEU
		UnitCreatePoint		= X:5.0 Y:0.0 Z:0.0
		NaturalRallyPoint	= X:7.0 Y:-80.0 Z:0.0	//NaturalRallyPointX must always match GeometryMajorRadius!
		ExitDelay			= 400					//Mainly for the multiple produced Red Guard.  Make them come out one at a time.
	End  
	
	//-----------------------------------------------
	Body                = StructureBody ModuleTag_05
		MaxHealth					= DWARVEN_SUMMONED_CITADEL_HEALTH
		MaxHealthDamaged  		    = DWARVEN_SUMMONED_CITADEL_HEALTH_DAMAGED
		MaxHealthReallyDamaged 	  	= DWARVEN_SUMMONED_CITADEL_HEALTH_REALLY_DAMAGED
	End
 
	Behavior                  = StructureCollapseUpdate ModuleTag_08
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_StructureMediumCollapse
		FXList                  = ALMOST_FINAL  FX_StructureAlmostCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight			= 155
	End
	
	Behavior = AIUpdateInterface ModuleTag_SoWeCanUseWeapon
		AILuaEventsList				= FortressFunctions ; ;
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate			= 250
	End

	Behavior = TunnelContain ModuleTag_Contain
 		ObjectStatusOfContained	= UNSELECTABLE CAN_ATTACK ENCLOSED
 		ContainMax              = 3
 		DamagePercentToUnits    = 0%
 		PassengerFilter			= ANY +INFANTRY +BANNER +CAVALRY -MONSTER -SUMMONED -COMBO_HORDE
 		AllowEnemiesInside      = No 
        AllowOwnPlayerInsideOverride	= Yes
		AllowAlliesInside       = No
        PassengerBonePrefix     		= PassengerBone:ARROW_ KindOf:INFANTRY		
 		NumberOfExitPaths       = 1		// Defaults to 1.  Set 0 to not use ExitStart/ExitEnd, set higher than 1 to use ExitStart01-nn/ExitEnd01-nn 		
 		EntryPosition			= X:7.0 Y:-40.0 Z:0.0
		EntryOffset				= X:7.0 Y:-80.0 Z:0.0
		ExitOffset				= X:7.0 Y:-80.0 Z:0.0
		EnterSound				= RuinedTowerEnterSound

		KillPassengersOnDeath	= No
		ShowPips				= No		
	End

	//----------------------------------
	//Wall Catapult Behaviors
	//This little bit here is to make sure the command set is not available until the buildup is finished.
	Behavior = GrantUpgradeCreate ModuleTag_Buildup
		UpgradeToGrant		= Upgrade_SummonedCitadelBuildup
	End 
	Behavior = ObjectCreationUpgrade ModuleTag_DelayCommandSetSwap
		TriggeredBy				= Upgrade_SummonedCitadelBuildup
		Delay									= 5000
  	RemoveUpgrade			= Upgrade_SummonedCitadelBuildup
		GrantUpgrade			= Upgrade_DwarvenFortressMightyCatapultReady
;		DestroyWhenSold 		= Yes
	End	
	Behavior = CommandSetUpgrade ModuleTag_TrebCommandSet3
		TriggeredBy			= Upgrade_DwarvenFortressMightyCatapultReady
		CommandSet			= DwarvenSummonedCitadelCommandSet
	End
	Behavior = ObjectCreationUpgrade MakeTheFreeTreb
		TriggeredBy		= Upgrade_DwarvenFortressMightyCatapultReady
		ThingToSpawn	= DwarvenCitadelMightyCatapult ; ; DwarvenFortressMightyCatapult ; ;DwarvenWallCatapult
		Offset			= X:0.0 Y:27.0 Z:110.0
		FadeInTime		= 600
	End
	Behavior = SlaveWatcherBehavior WatchTheTreb
	End

; ;>>>
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_CatapultEnabler
		SpecialPowerTemplate	= SpecialAbilityMightyCatapultLauncher_Citadel
		TriggeredBy	= Upgrade_DwarvenFortressMightyCatapultReady
	End
	Behavior = SpecialPowerModule ModuleTag_CatapultStarter       
		SpecialPowerTemplate		= SpecialAbilityMightyCatapultLauncher_Citadel
		UpdateModuleStartsAttack	= Yes
		StartsPaused		  		= Yes
		InitiateSound				= MightyCatapultStarterMS		
	End
	Behavior = WeaponFireSpecialAbilityUpdate ModuleTag_SpireWeaponFireUpdate   
		SpecialPowerTemplate    = SpecialAbilityMightyCatapultLauncher_Citadel
		WhichSpecialWeapon		= 1
		UnpackTime              = 10 
		PackTime                = 10
		SpecialWeapon			= DwarvenMightyCatapultFortressWeapon
		TriggerSound			= MightyCatapultRotateMS
		ApproachRequiresLOS		= No
	End
	Behavior = AutoAbilityBehavior ModuleTag_AutoAbilityLightningBehavior	
		SpecialAbility				= SpecialAbilityMightyCatapultLauncher_Citadel				// Use this ability
	End 
;;=;;
	Behavior = CastleUpgrade ModuleTag_PassOutDwarvenStoneworkUpgrade
		TriggeredBy	= Upgrade_DwarvenFortressDwarvenStoneworkTrigger
		Upgrade		= Upgrade_DwarvenFortressDwarvenStonework
		WallUpgradeRadius = ALL_FORTRESS_WALL_EFFECTIVE_RADIUS ;;=;; MEN_FORTRESS_WALL_EFFECTIVE_RADIUS
	End
	Behavior = SubObjectsUpgrade Armor_Upgrade
		TriggeredBy		= Upgrade_DwarvenFortressDwarvenStonework
		UpgradeTexture	= DBcitstatue.tga 0 dbcitstatue_u.tga
		UpgradeTexture	= DBfortress1.tga 0 DBFortress_U_cita.tga
		UpgradeTexture	= Dbstonea.tga 0 DBstonea_cita.tga
	End

	Behavior = AttributeModifierUpgrade ModuleTag_Reinforced ; ;
		TriggeredBy				= Upgrade_DwarvenFortressDwarvenStonework
		AttributeModifier		= DwarvenStoneworkKeep_Bonus
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_TowerArmorEnabler ; ;
		StartsActive	= No ;If no, requires upgrade to turn on.
		BonusName		= LoneTowerArmorEnabler
		TriggeredBy		= Upgrade_DwarvenFortressDwarvenStonework
		RefreshDelay	= 2000
		Range			= 9999
		ObjectFilter	= NONE +DwarvenSentryTower_Independent
	End
;;=;;
	//End Wall Catapult Behaviors
	//----------------------------------

	Geometry		     	= CYLINDER
	GeometryMajorRadius   	= 25	
	GeometryHeight        	= 95
	GeometryOffset			= X:35 Y:-5 Z:0

	AdditionalGeometry     	= BOX
	GeometryMajorRadius   	= 40
	GeometryMinorRadius   	= 30
	GeometryHeight        	= 85	
	GeometryOffset			= X:10 Y:-3 Z:0

	AdditionalGeometry     	= BOX
	GeometryMajorRadius   	= 15
	GeometryMinorRadius   	= 10
	GeometryHeight        	= 70	
	GeometryOffset			= X:65 Y:-10 Z:0

	AdditionalGeometry     	= BOX
	GeometryMajorRadius   	= 20
	GeometryMinorRadius   	= 15
	GeometryHeight        	= 55
	GeometryOffset			= X:-50 Y:-10 Z:0

	AdditionalGeometry		= CYLINDER
	GeometryMajorRadius		= 20
	GeometryHeight        	= 75
	GeometryOffset			= X:-35 Y:-5 Z:0
	
	AdditionalGeometry		= CYLINDER
	GeometryMajorRadius		= 30
	GeometryHeight        	= 110
	GeometryOffset			= X:0 Y:30 Z:0

	GeometryIsSmall       	= No
	Shadow                	= SHADOW_VOLUME
	BuildCompletion			= PLACED_BY_PLAYER

End

//------------------------------------------------------------------------------
// This is the one object that you would place on a map or the one that is summoned by the Summon Citadel spell
Object DwarvenSummonedCitadel											
	
	// It unpacks in to the keep and the buildplots.  It's an old CampFlag.
	Draw                = W3DScriptedModelDraw ModuleTag_01
		OkToChangeModelColor = Yes

		DefaultModelConditionState
			Model           = None
		End
	End	
																														  
	ArmorSet
		Conditions      = None
		Armor           = InvulnerableArmor
		DamageFX        = EmptyDamageFX   // just to avoid an assert
	End

	Side                = Dwarves
	EditorSorting       = STRUCTURE

	PlacementViewAngle = -45		// A -90 makes the door of the base face natural south.  0 would have it to the East.
	
	BuildCost           = 0
	BuildTime           = 5.0           // in seconds

	// *** ENGINEERING Parameters ***  
	RadarPriority       = STRUCTURE
	KindOf              = STRUCTURE SELECTABLE IMMOBILE BASE_FOUNDATION UNATTACKABLE BASE_SITE CAN_SEE_THROUGH_STRUCTURE
	Body                = ImmortalBody ModuleTag_02
		MaxHealth       = 1
	End  
	  
	Behavior = CastleBehavior ModuleTag_castle
  		CastleToUnpackForFaction	= Dwarves SummonedCitadel_Dwarven
		CastleToUnpackForFaction	= Men SummonedCitadel_Dwarven
		CastleToUnpackForFaction	= Elves SummonedCitadel_Dwarven		
		CastleToUnpackForFaction	= Wild SummonedCitadel_Dwarven
		CastleToUnpackForFaction	= Isengard SummonedCitadel_Dwarven
		CastleToUnpackForFaction	= Mordor SummonedCitadel_Dwarven

		//Anything that does not fit this filter will be given to the neutral player, so the template can have rocks and props.
		FilterValidOwnedEntries		= ANY +STRUCTURE +WALK_ON_TOP_OF_WALL +BASE_FOUNDATION +TACTICAL_MARKER		
		MaxCastleRadius 			= 100.0
		FadeTime					= 2.0								
		KeepDeathKillsEverything	= Yes
		Summoned					= Yes
		
		EvaEnemyCastleSightedEvent	= EnemyCitadelSighted
	End  
  
	Behavior            = GettingBuiltBehavior ModuleTag_GettingBuiltBehavior
		WorkerName	= DwarvenWorkerNoSelect
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End
	
	Geometry            = CYLINDER
	GeometryMajorRadius = 24.0
	GeometryMinorRadius = 24.0
	GeometryHeight      = 24.0
	GeometryIsSmall     = No
	Shadow				= SHADOW_VOLUME

End

